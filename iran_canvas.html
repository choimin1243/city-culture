<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë€ ìŠ¤íƒ€ì¼ ê±´ë¬¼ê³¼ ëª¨ìŠ¤í¬ - Canvas 2D</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #1a1f3a;
            font-family: 'Arial', sans-serif;
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
        }

        .info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(26, 31, 58, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #c9a961;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            color: #d4a574;
        }

        .info h2 {
            margin: 0 0 10px 0;
            font-size: 20px;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .info p {
            margin: 5px 0;
            font-size: 14px;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 31, 58, 0.9);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #c9a961;
            color: #d4a574;
        }

        .controls p {
            margin: 0;
            font-size: 14px;
            text-align: center;
        }

        .dialogue-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 700px;
            background: rgba(26, 40, 71, 0.95);
            padding: 25px 30px;
            border-radius: 12px;
            border: 3px solid rgba(201, 169, 97, 0.8);
            color: #fff;
            font-family: 'Georgia', serif;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            display: none;
        }

        .character-portrait {
            position: fixed;
            bottom: 220px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            display: none;
        }

        .character-portrait img {
            width: 350px;
            height: 450px;
            object-fit: contain;
            filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.7));
        }

        .dialogue-box .character-name {
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 12px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .dialogue-box .message {
            font-size: 17px;
            line-height: 1.7;
            color: #e8dcc8;
        }

        .dialogue-box .continue-hint {
            text-align: right;
            margin-top: 12px;
            font-size: 13px;
            color: #c9a961;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="info">
        <h2>ğŸ•Œ ì´ë€ ë§ˆì„ íƒí—˜</h2>
        <p><strong>ë°©í–¥í‚¤ / WASD:</strong> ì´ë™</p>
        <p><strong>í˜„ì¬ ìœ„ì¹˜:</strong> <span id="position">X: 0, Y: 0</span></p>
        <p><strong>ë°©í–¥:</strong> <span id="direction">ì •ë©´</span></p>
    </div>

    <div class="controls">
        <p>â¬†ï¸ â¬‡ï¸ â¬…ï¸ â¡ï¸ ë˜ëŠ” W A S D í‚¤ë¡œ ì´ë€ ë§ˆì„ì„ íƒí—˜í•˜ì„¸ìš”!</p>
    </div>

    <div id="characterPortrait" class="character-portrait">
        <img id="portraitImage" src="" alt="ìºë¦­í„°">
    </div>

    <div id="dialogueBox" class="dialogue-box">
        <div class="character-name" id="dialogueName"></div>
        <div class="message" id="dialogueMessage"></div>
        <div class="continue-hint">â–¼ ìŠ¤í˜ì´ìŠ¤ë¥¼ ëˆŒëŸ¬ ê³„ì†...</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        class IranianVillageGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');

                // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;

                // ìºë¦­í„° ìƒíƒœ
                this.character = {
                    x: this.canvas.width / 2,
                    y: Math.max(600, this.canvas.height / 2),
                    width: 60,
                    height: 60,
                    speed: 5,
                    velocityX: 0,
                    velocityY: 0,
                    direction: 'front',
                    isMoving: false
                };

                // ëŒ€í™” ì‹œìŠ¤í…œ
                this.dialogues = [
                    { name: "ë³´ê²½ (Bogyeong)", message: "ì´ë€ì— ë„ì°©í•´ì„œ ë¼ë¯¸ë¥´ë¥¼ ë§Œë‚˜ê¸°ë¡œ í–ˆëŠ”ë°.. ì´ë€ ë¬¸í™”ì— ëŒ€í•´ ë°°ìš°ê¸°ë¡œ í•´ì„œ ê¸°ëŒ€ë¼", character: "big" }
                ];
                this.currentDialogue = 0;
                this.dialogueActive = false;

                // ì´ë¯¸ì§€ ë¡œë“œ
                this.images = {};
                this.imagesLoaded = 0;
                this.totalImages = 8; // big, bogyeong ì¶”ê°€

                this.loadImages();

                // í‚¤ ì…ë ¥
                this.keys = {};
                this.setupEventListeners();

                // ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„
                this.animationFrame = 0;
                this.animationSpeed = 10;
                this.animationCounter = 0;

                // ë°°ê²½ ìš”ì†Œë“¤
                this.generateScenery();
            }

            generateScenery() {
                // ë³„ë“¤
                this.stars = [];
                for (let i = 0; i < 100; i++) {
                    this.stars.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * (this.canvas.height * 0.5),
                        size: Math.random() * 2 + 1,
                        twinkleSpeed: Math.random() * 0.05 + 0.01,
                        brightness: Math.random()
                    });
                }

                // ë„ë¡œ ê¸°ì¤€ì„ 
                const roadY = this.canvas.height * 0.7;

                // ì´ìŠ¬ëŒ ìŠ¤íƒ€ì¼ ê±´ë¬¼ë“¤ - ê°€ë¡œë¡œ 1ì¤„ ë°°ì¹˜
                this.buildings = [];
                const spacing = 250;
                const startX = 200;

                // ê±´ë¬¼ 1: ëª¨ìŠ¤í¬ ìŠ¤íƒ€ì¼ (ì‘ì€ ë”)
                this.buildings.push({
                    x: startX,
                    y: roadY,
                    width: 180,
                    height: 200,
                    style: 'mosque1',
                    doorX: startX,
                    doorY: roadY,
                    doorWidth: 50,
                    doorHeight: 70
                });

                // ê±´ë¬¼ 2: íˆì¡ ê°€ê²Œ (ì•„ì¹˜í˜• ë¬¸)
                this.buildings.push({
                    x: startX + spacing,
                    y: roadY,
                    width: 200,
                    height: 220,
                    style: 'hijab',
                    doorX: startX + spacing,
                    doorY: roadY,
                    doorWidth: 60,
                    doorHeight: 80,
                    signText: 'íˆì¡'
                });

                // ê±´ë¬¼ 3: ëª¨ìŠ¤í¬ ìŠ¤íƒ€ì¼ (ìŒ ì²¨íƒ‘)
                this.buildings.push({
                    x: startX + spacing * 2,
                    y: roadY,
                    width: 220,
                    height: 240,
                    style: 'mosque2',
                    doorX: startX + spacing * 2,
                    doorY: roadY,
                    doorWidth: 55,
                    doorHeight: 75
                });

                // ê±´ë¬¼ 4: ì¼ë°˜ ì´ìŠ¬ëŒ ê±´ë¬¼ (ì•„ì¹˜ ì°½ë¬¸)
                this.buildings.push({
                    x: startX + spacing * 3,
                    y: roadY,
                    width: 170,
                    height: 190,
                    style: 'islamic1',
                    doorX: startX + spacing * 3,
                    doorY: roadY,
                    doorWidth: 50,
                    doorHeight: 70
                });

                // ê±´ë¬¼ 5: ì¥ì‹ ë” ê±´ë¬¼
                this.buildings.push({
                    x: startX + spacing * 4,
                    y: roadY,
                    width: 190,
                    height: 210,
                    style: 'islamic2',
                    doorX: startX + spacing * 4,
                    doorY: roadY,
                    doorWidth: 52,
                    doorHeight: 72
                });

                // ì•¼ììˆ˜ë“¤ (ê±´ë¬¼ ì‚¬ì´)
                this.palmTrees = [
                    { x: startX - 80, y: roadY + 10 },
                    { x: startX + spacing * 0.5 + 20, y: roadY + 10 },
                    { x: startX + spacing * 1.5 + 30, y: roadY + 10 },
                    { x: startX + spacing * 2.5 - 20, y: roadY + 10 },
                    { x: startX + spacing * 3.5 + 10, y: roadY + 10 },
                    { x: startX + spacing * 4 + 120, y: roadY + 10 }
                ];

                // ì‚¬ë§‰ ì–¸ë•ë“¤
                this.dunes = [
                    { x: 0, y: this.canvas.height * 0.82, width: 500, height: 40 },
                    { x: 400, y: this.canvas.height * 0.84, width: 600, height: 35 },
                    { x: 900, y: this.canvas.height * 0.83, width: 550, height: 38 }
                ];
            }

            loadImages() {
                const imageNames = [
                    'front1_no_bg',
                    'front222',
                    'left1_no_bg',
                    'left2-removebg-preview',
                    'right1_no_bg',
                    'right2_no_bg',
                    'big_no_bg',
                    'bogyeong_no_bg'
                ];

                imageNames.forEach(name => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        this.imagesLoaded++;
                        if (this.imagesLoaded === this.totalImages) {
                            this.start();
                        }
                    };
                    img.onerror = () => {
                        console.error(`Failed to load image: ${name}`);
                        this.imagesLoaded++;
                        if (this.imagesLoaded === this.totalImages) {
                            this.start();
                        }
                    };
                    img.src = `https://cdn.jsdelivr.net/gh/choimin1243/11122212/${name}.png`;
                    this.images[name] = img;
                });
            }

            setupEventListeners() {
                window.addEventListener('keydown', (e) => {
                    this.keys[e.key.toLowerCase()] = true;

                    // ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ëŒ€í™” ì§„í–‰
                    if (e.key === ' ' && this.dialogueActive) {
                        e.preventDefault();
                        this.showDialogue(this.currentDialogue + 1);
                    }
                });

                window.addEventListener('keyup', (e) => {
                    this.keys[e.key.toLowerCase()] = false;
                });

                window.addEventListener('resize', () => {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                    this.generateScenery();
                });
            }

            showDialogue(index) {
                if (index >= this.dialogues.length) {
                    this.hideDialogue();
                    return;
                }

                this.dialogueActive = true;
                this.currentDialogue = index;
                const dialogue = this.dialogues[index];

                // ëŒ€í™” UI í‘œì‹œ
                document.getElementById('dialogueName').textContent = dialogue.name;
                document.getElementById('dialogueMessage').textContent = dialogue.message;
                document.getElementById('dialogueBox').style.display = 'block';

                // ìºë¦­í„° ì´ˆìƒí™” í‘œì‹œ
                const portrait = document.getElementById('characterPortrait');
                const portraitImg = document.getElementById('portraitImage');

                const characterType = dialogue.character || 'big';
                const imageUrl = characterType === 'bogyeong'
                    ? 'https://cdn.jsdelivr.net/gh/choimin1243/11122212/bogyeong_no_bg.png'
                    : 'https://cdn.jsdelivr.net/gh/choimin1243/11122212/big_no_bg.png';

                portraitImg.src = imageUrl;
                portrait.style.display = 'block';
            }

            hideDialogue() {
                this.dialogueActive = false;
                document.getElementById('dialogueBox').style.display = 'none';
                document.getElementById('characterPortrait').style.display = 'none';
            }

            update() {
                // ëŒ€í™” ì¤‘ì—ëŠ” ì›€ì§ì„ ì œí•œ
                if (this.dialogueActive) {
                    this.character.velocityX *= 0.9;
                    this.character.velocityY *= 0.9;
                    return;
                }

                // ì´ë™ ì²˜ë¦¬
                let targetVelX = 0;
                let targetVelY = 0;
                let newDirection = this.character.direction;

                if (this.keys['arrowleft'] || this.keys['a']) {
                    targetVelX = -this.character.speed;
                    newDirection = 'left';
                }
                if (this.keys['arrowright'] || this.keys['d']) {
                    targetVelX = this.character.speed;
                    newDirection = 'right';
                }
                if (this.keys['arrowup'] || this.keys['w']) {
                    targetVelY = -this.character.speed;
                    if (!newDirection.includes('left') && !newDirection.includes('right')) {
                        newDirection = 'front';
                    }
                }
                if (this.keys['arrowdown'] || this.keys['s']) {
                    targetVelY = this.character.speed;
                    if (!newDirection.includes('left') && !newDirection.includes('right')) {
                        newDirection = 'front';
                    }
                }

                // ë¶€ë“œëŸ¬ìš´ ê°€ì†
                this.character.velocityX += (targetVelX - this.character.velocityX) * 0.2;
                this.character.velocityY += (targetVelY - this.character.velocityY) * 0.2;

                // ì´ë™ ì—¬ë¶€ í™•ì¸
                this.character.isMoving = Math.abs(this.character.velocityX) > 0.1 || Math.abs(this.character.velocityY) > 0.1;

                if (this.character.isMoving) {
                    this.character.direction = newDirection;
                }

                // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                this.character.x += this.character.velocityX;
                this.character.y += this.character.velocityY;

                // ê²½ê³„ ì²´í¬
                this.character.x = Math.max(this.character.width / 2, Math.min(this.canvas.width - this.character.width / 2, this.character.x));
                // Y ì¢Œí‘œëŠ” ìµœì†Œ 600, ìµœëŒ€ëŠ” í™”ë©´ í•˜ë‹¨
                this.character.y = Math.max(600, Math.min(this.canvas.height - this.character.height / 2, this.character.y));

                // ë¬¸ ì•ì— ìˆëŠ”ì§€ ì²´í¬ (íˆì¡ ê°€ê²Œ ë¬¸)
                this.character.visible = true;
                this.buildings.forEach(building => {
                    if (building.style === 'hijab') {
                        const distX = Math.abs(this.character.x - building.doorX);
                        const distY = Math.abs(this.character.y - building.doorY);

                        // ë¬¸ ì• 50px ë²”ìœ„ ë‚´ì— ìˆìœ¼ë©´ ìºë¦­í„° ìˆ¨ê¹€
                        if (distX < building.doorWidth && distY < 30) {
                            this.character.visible = false;
                        }
                    }
                });

                // ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ì—…ë°ì´íŠ¸
                if (this.character.isMoving) {
                    this.animationCounter++;
                    if (this.animationCounter >= this.animationSpeed) {
                        this.animationFrame = (this.animationFrame + 1) % 2;
                        this.animationCounter = 0;
                    }
                } else {
                    this.animationFrame = 0;
                }

                // ë³„ ë°˜ì§ì„ ì—…ë°ì´íŠ¸
                this.stars.forEach(star => {
                    star.brightness += star.twinkleSpeed;
                    if (star.brightness > 1 || star.brightness < 0) {
                        star.twinkleSpeed = -star.twinkleSpeed;
                    }
                });

                // UI ì—…ë°ì´íŠ¸
                this.updateUI();
            }

            updateUI() {
                document.getElementById('position').textContent =
                    `X: ${Math.round(this.character.x)}, Y: ${Math.round(this.character.y)}`;

                const directionText = {
                    'front': 'ì •ë©´',
                    'left': 'ì™¼ìª½',
                    'right': 'ì˜¤ë¥¸ìª½'
                };
                document.getElementById('direction').textContent = directionText[this.character.direction] || 'ì •ë©´';
            }

            drawBackground() {
                // ë°¤í•˜ëŠ˜ ê·¸ë¼ë””ì–¸íŠ¸
                const skyGradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height * 0.7);
                skyGradient.addColorStop(0, '#1a1f3a');
                skyGradient.addColorStop(0.2, '#2d3a5f');
                skyGradient.addColorStop(0.5, '#7d4e57');
                skyGradient.addColorStop(0.8, '#b8735a');
                skyGradient.addColorStop(1, '#c9a961');
                this.ctx.fillStyle = skyGradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height * 0.7);

                // ë³„ ê·¸ë¦¬ê¸°
                this.stars.forEach(star => {
                    this.ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness})`;
                    this.ctx.beginPath();
                    this.ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    this.ctx.fill();
                });

                // ë‹¬
                this.ctx.save();
                this.ctx.fillStyle = '#ffe4b5';
                this.ctx.shadowBlur = 30;
                this.ctx.shadowColor = 'rgba(255, 228, 181, 0.5)';
                this.ctx.beginPath();
                this.ctx.arc(this.canvas.width - 200, 100, 45, 0, Math.PI * 2);
                this.ctx.fill();

                // ë‹¬ í¬ë ˆì´í„° íš¨ê³¼
                this.ctx.shadowBlur = 0;
                this.ctx.fillStyle = 'rgba(26, 31, 58, 0.1)';
                this.ctx.beginPath();
                this.ctx.arc(this.canvas.width - 185, 95, 45, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.restore();

                // ë•…/ì‚¬ë§‰
                const groundGradient = this.ctx.createLinearGradient(0, this.canvas.height * 0.7, 0, this.canvas.height);
                groundGradient.addColorStop(0, '#c9a961');
                groundGradient.addColorStop(0.3, '#b8935a');
                groundGradient.addColorStop(1, '#8b7355');
                this.ctx.fillStyle = groundGradient;
                this.ctx.fillRect(0, this.canvas.height * 0.7, this.canvas.width, this.canvas.height * 0.3);

                // ë„ë¡œ ê·¸ë¦¬ê¸° (ì´ë€ ìŠ¤íƒ€ì¼)
                const roadY = this.canvas.height * 0.7;
                const roadHeight = 80;

                // ë©”ì¸ ë„ë¡œ
                this.ctx.fillStyle = '#8b7060';
                this.ctx.fillRect(0, roadY, this.canvas.width, roadHeight);

                // ë„ë¡œ í…Œë‘ë¦¬ (ìƒë‹¨)
                this.ctx.strokeStyle = '#6b5545';
                this.ctx.lineWidth = 3;
                this.ctx.beginPath();
                this.ctx.moveTo(0, roadY);
                this.ctx.lineTo(this.canvas.width, roadY);
                this.ctx.stroke();

                // ë„ë¡œ ì¥ì‹ íŒ¨í„´ (ì´ìŠ¬ëŒ ìŠ¤íƒ€ì¼)
                this.ctx.strokeStyle = '#a08565';
                this.ctx.lineWidth = 2;
                for (let x = 0; x < this.canvas.width; x += 60) {
                    // ë‹¤ì´ì•„ëª¬ë“œ íŒ¨í„´
                    this.ctx.beginPath();
                    this.ctx.moveTo(x + 30, roadY + 15);
                    this.ctx.lineTo(x + 40, roadY + 25);
                    this.ctx.lineTo(x + 30, roadY + 35);
                    this.ctx.lineTo(x + 20, roadY + 25);
                    this.ctx.closePath();
                    this.ctx.stroke();
                }

                // ì‚¬ë§‰ ì–¸ë• ê·¸ë¦¬ê¸°
                this.dunes.forEach(dune => {
                    this.ctx.fillStyle = '#a08060';
                    this.ctx.beginPath();
                    this.ctx.ellipse(dune.x + dune.width / 2, dune.y, dune.width / 2, dune.height / 2, 0, 0, Math.PI * 2);
                    this.ctx.fill();
                });
            }

            drawBuilding(building) {
                const { x, y, width, height, style, signText } = building;

                this.ctx.save();

                // ê±´ë¬¼ ë³¸ì²´
                this.ctx.fillStyle = '#d4b896';
                this.ctx.fillRect(x - width / 2, y - height, width, height);

                // ê±´ë¬¼ í…Œë‘ë¦¬
                this.ctx.strokeStyle = '#a08848';
                this.ctx.lineWidth = 4;
                this.ctx.strokeRect(x - width / 2, y - height, width, height);

                if (style === 'mosque1') {
                    // ì‘ì€ ë” ëª¨ìŠ¤í¬
                    // ë” ì§€ë¶•
                    this.ctx.fillStyle = '#5a9a5a';
                    this.ctx.beginPath();
                    this.ctx.ellipse(x, y - height, width * 0.4, 35, 0, Math.PI, 0, true);
                    this.ctx.fill();
                    this.ctx.strokeStyle = '#4a8a4a';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();

                    // ì´ˆìŠ¹ë‹¬ ì¥ì‹
                    this.ctx.fillStyle = '#ffd700';
                    this.ctx.beginPath();
                    this.ctx.arc(x - 4, y - height - 38, 6, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.beginPath();
                    this.ctx.arc(x, y - height - 38, 6, 0, Math.PI * 2);
                    this.ctx.fillStyle = '#5a9a5a';
                    this.ctx.fill();

                    // ì•„ì¹˜í˜• ì°½ë¬¸ë“¤
                    [-40, 40].forEach(offsetX => {
                        this.ctx.fillStyle = '#6b5d4f';
                        this.ctx.beginPath();
                        this.ctx.moveTo(x + offsetX - 15, y - height + 80);
                        this.ctx.lineTo(x + offsetX - 15, y - height + 50);
                        this.ctx.quadraticCurveTo(x + offsetX - 15, y - height + 35, x + offsetX, y - height + 35);
                        this.ctx.quadraticCurveTo(x + offsetX + 15, y - height + 35, x + offsetX + 15, y - height + 50);
                        this.ctx.lineTo(x + offsetX + 15, y - height + 80);
                        this.ctx.closePath();
                        this.ctx.fill();
                        this.ctx.strokeStyle = '#4a3828';
                        this.ctx.lineWidth = 2;
                        this.ctx.stroke();
                    });

                    // ì•„ì¹˜í˜• ë¬¸
                    this.ctx.fillStyle = '#3a2818';
                    this.ctx.beginPath();
                    this.ctx.moveTo(x - 25, y);
                    this.ctx.lineTo(x - 25, y - 50);
                    this.ctx.quadraticCurveTo(x - 25, y - 70, x, y - 70);
                    this.ctx.quadraticCurveTo(x + 25, y - 70, x + 25, y - 50);
                    this.ctx.lineTo(x + 25, y);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.strokeStyle = '#2a1808';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();

                } else if (style === 'hijab') {
                    // íˆì¡ ê°€ê²Œ - íŠ¹ë³„í•œ ë””ìì¸
                    // ì¥ì‹ ì§€ë¶•
                    this.ctx.fillStyle = '#c94a4a';
                    this.ctx.beginPath();
                    this.ctx.moveTo(x - width / 2 - 10, y - height);
                    this.ctx.lineTo(x, y - height - 35);
                    this.ctx.lineTo(x + width / 2 + 10, y - height);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.strokeStyle = '#a03a3a';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();

                    // ê°„íŒ ë°°ê²½
                    this.ctx.fillStyle = '#2a1f3a';
                    this.ctx.fillRect(x - 80, y - height - 70, 160, 40);
                    this.ctx.strokeStyle = '#ffd700';
                    this.ctx.lineWidth = 3;
                    this.ctx.strokeRect(x - 80, y - height - 70, 160, 40);

                    // ê°„íŒ ì¥ì‹
                    for (let i = 0; i < 5; i++) {
                        this.ctx.fillStyle = '#ffd700';
                        this.ctx.beginPath();
                        this.ctx.arc(x - 60 + i * 30, y - height - 75, 4, 0, Math.PI * 2);
                        this.ctx.fill();
                    }

                    // "íˆì¡" í…ìŠ¤íŠ¸
                    this.ctx.fillStyle = '#ffd700';
                    this.ctx.font = 'bold 32px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText('íˆì¡', x, y - height - 50);

                    // ì•„ì¹˜í˜• ëŒ€ë¬¸ (í¼)
                    this.ctx.fillStyle = '#2a1808';
                    this.ctx.beginPath();
                    this.ctx.moveTo(x - 30, y);
                    this.ctx.lineTo(x - 30, y - 60);
                    this.ctx.quadraticCurveTo(x - 30, y - 80, x, y - 80);
                    this.ctx.quadraticCurveTo(x + 30, y - 80, x + 30, y - 60);
                    this.ctx.lineTo(x + 30, y);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.strokeStyle = '#ffd700';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();

                    // ë¬¸ ì†ì¡ì´
                    this.ctx.fillStyle = '#ffd700';
                    this.ctx.beginPath();
                    this.ctx.arc(x + 15, y - 40, 5, 0, Math.PI * 2);
                    this.ctx.fill();

                    // ì¥ì‹ ì°½ë¬¸ë“¤
                    [-50, 50].forEach(offsetX => {
                        this.ctx.fillStyle = '#8a6a8a';
                        this.ctx.beginPath();
                        this.ctx.moveTo(x + offsetX - 15, y - height + 100);
                        this.ctx.lineTo(x + offsetX - 15, y - height + 70);
                        this.ctx.quadraticCurveTo(x + offsetX - 15, y - height + 55, x + offsetX, y - height + 55);
                        this.ctx.quadraticCurveTo(x + offsetX + 15, y - height + 55, x + offsetX + 15, y - height + 70);
                        this.ctx.lineTo(x + offsetX + 15, y - height + 100);
                        this.ctx.closePath();
                        this.ctx.fill();
                        this.ctx.strokeStyle = '#6a4a6a';
                        this.ctx.lineWidth = 2;
                        this.ctx.stroke();
                    });

                } else if (style === 'mosque2') {
                    // ìŒ ì²¨íƒ‘ ëª¨ìŠ¤í¬
                    // ì¤‘ì•™ í° ë”
                    this.ctx.fillStyle = '#4a8a7a';
                    this.ctx.beginPath();
                    this.ctx.ellipse(x, y - height, width * 0.45, 40, 0, Math.PI, 0, true);
                    this.ctx.fill();
                    this.ctx.strokeStyle = '#3a7a6a';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();

                    // ì¤‘ì•™ ì´ˆìŠ¹ë‹¬
                    this.ctx.fillStyle = '#ffd700';
                    this.ctx.beginPath();
                    this.ctx.arc(x - 5, y - height - 45, 7, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.beginPath();
                    this.ctx.arc(x, y - height - 45, 7, 0, Math.PI * 2);
                    this.ctx.fillStyle = '#4a8a7a';
                    this.ctx.fill();

                    // ì¢Œìš° ì‘ì€ ì²¨íƒ‘
                    [-70, 70].forEach(offsetX => {
                        // ì²¨íƒ‘ ê¸°ë‘¥
                        this.ctx.fillStyle = '#b8935a';
                        this.ctx.fillRect(x + offsetX - 12, y - height + 40, 24, 120);
                        this.ctx.strokeStyle = '#a08848';
                        this.ctx.lineWidth = 3;
                        this.ctx.strokeRect(x + offsetX - 12, y - height + 40, 24, 120);

                        // ì²¨íƒ‘ ë°œì½”ë‹ˆ
                        this.ctx.fillStyle = '#c9a961';
                        this.ctx.fillRect(x + offsetX - 18, y - height + 100, 36, 12);
                        this.ctx.strokeRect(x + offsetX - 18, y - height + 100, 36, 12);

                        // ì²¨íƒ‘ ë”
                        this.ctx.fillStyle = '#4a8a7a';
                        this.ctx.beginPath();
                        this.ctx.ellipse(x + offsetX, y - height + 40, 16, 10, 0, Math.PI, 0, true);
                        this.ctx.fill();
                        this.ctx.strokeStyle = '#3a7a6a';
                        this.ctx.stroke();

                        // ì²¨íƒ‘ ì´ˆìŠ¹ë‹¬
                        this.ctx.fillStyle = '#ffd700';
                        this.ctx.beginPath();
                        this.ctx.arc(x + offsetX - 3, y - height + 27, 5, 0, Math.PI * 2);
                        this.ctx.fill();
                        this.ctx.beginPath();
                        this.ctx.arc(x + offsetX, y - height + 27, 5, 0, Math.PI * 2);
                        this.ctx.fillStyle = '#4a8a7a';
                        this.ctx.fill();
                    });

                    // ì•„ì¹˜í˜• ë¬¸
                    this.ctx.fillStyle = '#2a1808';
                    this.ctx.beginPath();
                    this.ctx.moveTo(x - 27, y);
                    this.ctx.lineTo(x - 27, y - 55);
                    this.ctx.quadraticCurveTo(x - 27, y - 75, x, y - 75);
                    this.ctx.quadraticCurveTo(x + 27, y - 75, x + 27, y - 55);
                    this.ctx.lineTo(x + 27, y);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.strokeStyle = '#ffd700';
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();

                } else if (style === 'islamic1') {
                    // ì¼ë°˜ ì´ìŠ¬ëŒ ê±´ë¬¼ (ì•„ì¹˜ ì°½ë¬¸)
                    // í‰í‰í•œ ì§€ë¶•
                    this.ctx.fillStyle = '#a08848';
                    this.ctx.fillRect(x - width / 2 - 8, y - height - 12, width + 16, 12);
                    this.ctx.strokeStyle = '#806838';
                    this.ctx.lineWidth = 3;
                    this.ctx.strokeRect(x - width / 2 - 8, y - height - 12, width + 16, 12);

                    // ì•„ì¹˜í˜• ì°½ë¬¸ë“¤ (3ê°œ)
                    for (let i = -1; i <= 1; i++) {
                        this.ctx.fillStyle = '#6b5d4f';
                        this.ctx.beginPath();
                        this.ctx.moveTo(x + i * 45 - 15, y - height + 100);
                        this.ctx.lineTo(x + i * 45 - 15, y - height + 65);
                        this.ctx.quadraticCurveTo(x + i * 45 - 15, y - height + 50, x + i * 45, y - height + 50);
                        this.ctx.quadraticCurveTo(x + i * 45 + 15, y - height + 50, x + i * 45 + 15, y - height + 65);
                        this.ctx.lineTo(x + i * 45 + 15, y - height + 100);
                        this.ctx.closePath();
                        this.ctx.fill();
                        this.ctx.strokeStyle = '#4a3828';
                        this.ctx.lineWidth = 2;
                        this.ctx.stroke();
                    }

                    // ì•„ì¹˜í˜• ë¬¸
                    this.ctx.fillStyle = '#3a2818';
                    this.ctx.beginPath();
                    this.ctx.moveTo(x - 25, y);
                    this.ctx.lineTo(x - 25, y - 50);
                    this.ctx.quadraticCurveTo(x - 25, y - 70, x, y - 70);
                    this.ctx.quadraticCurveTo(x + 25, y - 70, x + 25, y - 50);
                    this.ctx.lineTo(x + 25, y);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.strokeStyle = '#2a1808';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();

                } else if (style === 'islamic2') {
                    // ì¥ì‹ ë” ê±´ë¬¼
                    // ì‘ì€ ë” 3ê°œ
                    [-50, 0, 50].forEach((offsetX, i) => {
                        const domeSize = i === 1 ? 45 : 35;
                        this.ctx.fillStyle = i === 1 ? '#6a8a9a' : '#5a7a8a';
                        this.ctx.beginPath();
                        this.ctx.ellipse(x + offsetX, y - height, domeSize, domeSize * 0.6, 0, Math.PI, 0, true);
                        this.ctx.fill();
                        this.ctx.strokeStyle = i === 1 ? '#5a7a8a' : '#4a6a7a';
                        this.ctx.lineWidth = 2;
                        this.ctx.stroke();

                        if (i === 1) {
                            // ì¤‘ì•™ ë”ì— ì´ˆìŠ¹ë‹¬
                            this.ctx.fillStyle = '#ffd700';
                            this.ctx.beginPath();
                            this.ctx.arc(x + offsetX - 4, y - height - domeSize * 0.6 - 5, 5, 0, Math.PI * 2);
                            this.ctx.fill();
                            this.ctx.beginPath();
                            this.ctx.arc(x + offsetX, y - height - domeSize * 0.6 - 5, 5, 0, Math.PI * 2);
                            this.ctx.fillStyle = '#6a8a9a';
                            this.ctx.fill();
                        }
                    });

                    // ì•„ì¹˜í˜• ì°½ë¬¸ë“¤
                    [-40, 40].forEach(offsetX => {
                        this.ctx.fillStyle = '#7b6d5f';
                        this.ctx.beginPath();
                        this.ctx.moveTo(x + offsetX - 15, y - height + 120);
                        this.ctx.lineTo(x + offsetX - 15, y - height + 85);
                        this.ctx.quadraticCurveTo(x + offsetX - 15, y - height + 70, x + offsetX, y - height + 70);
                        this.ctx.quadraticCurveTo(x + offsetX + 15, y - height + 70, x + offsetX + 15, y - height + 85);
                        this.ctx.lineTo(x + offsetX + 15, y - height + 120);
                        this.ctx.closePath();
                        this.ctx.fill();
                        this.ctx.strokeStyle = '#5a4828';
                        this.ctx.lineWidth = 2;
                        this.ctx.stroke();
                    });

                    // ì•„ì¹˜í˜• ë¬¸
                    this.ctx.fillStyle = '#2a1808';
                    this.ctx.beginPath();
                    this.ctx.moveTo(x - 26, y);
                    this.ctx.lineTo(x - 26, y - 52);
                    this.ctx.quadraticCurveTo(x - 26, y - 72, x, y - 72);
                    this.ctx.quadraticCurveTo(x + 26, y - 72, x + 26, y - 52);
                    this.ctx.lineTo(x + 26, y);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.strokeStyle = '#1a0808';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                }

                this.ctx.restore();
            }

            drawPalmTree(x, y) {
                // ì•¼ììˆ˜ ì¤„ê¸°
                this.ctx.fillStyle = '#8b6f47';
                this.ctx.fillRect(x - 7.5, y - 80, 15, 80);

                // ì¤„ê¸° ì§ˆê°
                this.ctx.strokeStyle = '#6b5537';
                this.ctx.lineWidth = 2;
                for (let i = 0; i < 5; i++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x - 7.5, y - 15 - i * 15);
                    this.ctx.lineTo(x + 7.5, y - 15 - i * 15);
                    this.ctx.stroke();
                }

                // ì•¼ììˆ˜ ì
                this.ctx.save();
                this.ctx.translate(x, y - 80);

                for (let i = 0; i < 8; i++) {
                    const angle = (i * Math.PI * 2) / 8;
                    this.ctx.save();
                    this.ctx.rotate(angle);

                    // ì ê·¸ë¦¬ê¸°
                    this.ctx.fillStyle = '#4a7c4a';
                    this.ctx.beginPath();
                    this.ctx.ellipse(25, 0, 35, 10, 0, 0, Math.PI * 2);
                    this.ctx.fill();

                    // ì í…Œë‘ë¦¬
                    this.ctx.strokeStyle = '#3a6c3a';
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();

                    this.ctx.restore();
                }

                this.ctx.restore();
            }

            drawCharacter() {
                // ìºë¦­í„°ê°€ ë³´ì´ì§€ ì•Šìœ¼ë©´ ê·¸ë¦¬ì§€ ì•ŠìŒ
                if (!this.character.visible) {
                    return;
                }

                // ê·¸ë¦¼ì
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                this.ctx.beginPath();
                this.ctx.ellipse(
                    this.character.x,
                    this.character.y + this.character.height / 2 + 10,
                    this.character.width * 0.3,
                    this.character.height * 0.1,
                    0, 0, Math.PI * 2
                );
                this.ctx.fill();

                // ìºë¦­í„° ì´ë¯¸ì§€ ì„ íƒ
                let imageName;
                if (this.character.direction === 'left') {
                    imageName = this.animationFrame === 0 ? 'left1_no_bg' : 'left2-removebg-preview';
                } else if (this.character.direction === 'right') {
                    imageName = this.animationFrame === 0 ? 'right1_no_bg' : 'right2_no_bg';
                } else { // front
                    imageName = this.animationFrame === 0 ? 'front1_no_bg' : 'front222';
                }

                const img = this.images[imageName];
                if (img && img.complete) {
                    const targetWidth = this.character.width;
                    const targetHeight = this.character.height;
                    const imgRatio = img.width / img.height;
                    const targetRatio = targetWidth / targetHeight;

                    let drawWidth, drawHeight, offsetX, offsetY;

                    if (imgRatio > targetRatio) {
                        drawWidth = targetWidth;
                        drawHeight = targetWidth / imgRatio;
                        offsetX = 0;
                        offsetY = (targetHeight - drawHeight) / 2;
                    } else {
                        drawHeight = targetHeight;
                        drawWidth = targetHeight * imgRatio;
                        offsetX = (targetWidth - drawWidth) / 2;
                        offsetY = 0;
                    }

                    this.ctx.drawImage(
                        img,
                        this.character.x - this.character.width / 2 + offsetX,
                        this.character.y - this.character.height / 2 + offsetY,
                        drawWidth,
                        drawHeight
                    );
                }
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // ë°°ê²½ ê·¸ë¦¬ê¸°
                this.drawBackground();

                // ê±´ë¬¼ë“¤ ê·¸ë¦¬ê¸° (ì´ìŠ¬ëŒ ìŠ¤íƒ€ì¼)
                this.buildings.forEach(building => {
                    this.drawBuilding(building);
                });

                // ì•¼ììˆ˜ë“¤ ê·¸ë¦¬ê¸°
                this.palmTrees.forEach(tree => {
                    this.drawPalmTree(tree.x, tree.y);
                });

                // ìºë¦­í„° ê·¸ë¦¬ê¸° (ê°€ì¥ ì•)
                this.drawCharacter();
            }

            gameLoop() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.gameLoop());
            }

            start() {
                console.log('ì´ë€ ë§ˆì„ ê²Œì„ ì‹œì‘! ëª¨ë“  ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ');

                // ê²Œì„ ì‹œì‘ 1ì´ˆ í›„ ì˜¤í”„ë‹ ëŒ€í™” ì‹œì‘
                setTimeout(() => {
                    this.showDialogue(0);
                }, 1000);

                this.gameLoop();
            }
        }

        // ê²Œì„ ì‹œì‘
        window.addEventListener('load', () => {
            new IranianVillageGame();
        });
    </script>
</body>
</html>
